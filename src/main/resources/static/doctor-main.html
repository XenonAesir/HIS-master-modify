<!doctype html>
<html class="no-js" lang="zxx">

<head>
    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="keywords" content="Site keywords here">
    <meta name="description" content="">
    <meta name='copyright' content=''>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Title -->
    <title></title>

    <!-- Favicon -->
    <link rel="icon" href="img/favicon.png">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css?family=Poppins:200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap"
        rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- Nice Select CSS -->
    <link rel="stylesheet" href="css/nice-select.css">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <!-- icofont CSS -->
    <link rel="stylesheet" href="css/icofont.css">
    <!-- Slicknav -->
    <link rel="stylesheet" href="css/slicknav.min.css">
    <!-- Owl Carousel CSS -->
    <link rel="stylesheet" href="css/owl-carousel.css">
    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="css/datepicker.css">
    <!-- Animate CSS -->
    <link rel="stylesheet" href="css/animate.min.css">
    <!-- Magnific Popup CSS -->
    <link rel="stylesheet" href="css/magnific-popup.css">

    <!-- Medipro CSS -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/responsive.css">

    <!-- Color CSS -->
    <link rel="stylesheet" href="css/color/color1.css">
    <!--<link rel="stylesheet" href="css/color/color2.css">-->
    <!--<link rel="stylesheet" href="css/color/color3.css">-->
    <!--<link rel="stylesheet" href="css/color/color4.css">-->
    <!--<link rel="stylesheet" href="css/color/color5.css">-->
    <!--<link rel="stylesheet" href="css/color/color6.css">-->
    <!--<link rel="stylesheet" href="css/color/color7.css">-->
    <!--<link rel="stylesheet" href="css/color/color8.css">-->
    <!--<link rel="stylesheet" href="css/color/color9.css">-->
    <!--<link rel="stylesheet" href="css/color/color10.css">-->
    <!--<link rel="stylesheet" href="css/color/color11.css">-->
    <!--<link rel="stylesheet" href="css/color/color12.css">-->

    <link rel="stylesheet" href="#" id="colors">


</head>

<body>

    <header class="header style2">
        <!-- Middle Header -->
        <div class="middle-header" style="padding: 0; padding-top: 10px;">
            <div class="container">
                <div class="row">
                    <div class="col-lg-3 col-md-3 col-12">
                        <!-- Start Logo -->
                        <div class="logo">
                            <img src="img/logo.png" alt="#">
                        </div>
                        <!-- End Logo -->
                        <!-- Mobile Nav -->
                        <div class="mobile-nav"></div>
                        <!-- End Mobile Nav -->
                    </div>
                    <div class="col-lg-9 col-md-9 col-12">
                        <div class="widget-main">
                            <!-- Single Widget -->
                            <div class="single-widget button">
                                <div style="float:left; margin-top: 10px; margin-right: 20px">
                                    工号：<span id="doctor-id"></span>
                                </div>
                                <div class="get-quote" style="float: right;">
                                    <a href="index2.html" class="btn">退出</a>
                                </div>
                            </div>
                            <!--/ End Single Widget -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Middle Header -->

    </header>

    <!-- Start portfolio -->
    <section class="portfolio section" style="padding-top: 20px; height: 60%; width: 100%; ">

        <!-- Start function: records, checkups, prescriptions -->
        <header class="header style2">
            <div class="header-inner">
                <div class="container">
                    <div class="inner">
                        <div class="row">
                            <div class="col-12" style="height: auto;">
                                <!-- Main Menu -->
                                <div class="main-menu" style="float: left;">
                                    <nav class="navigation">
                                        <ul class="nav menu">
                                            <li class="active" id="records"><a href="#" onclick="showRecords()">近期出诊</a>
                                            </li>
                                            <li id="checkups"><a href="#" onclick="showCheckups()">停诊申请</a></li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--/ End Header Inner -->
        </header>
        <!-- End function: records, checkups, prescriptions -->

        <div class="container">
            <!-- Start records -->
            <div class="func-option doc-records" id="doc-records" style="display: block;">


                <div id="appointmentTableContainer">
                    <!-- 表格将显示在这个容器中 -->
                </div>

                <!-- 病历模板选择 -->
                <!-- <div class="doc-records-format">
                    </div> -->
            </div>
            <!-- End records -->

            <!-- Start checkups -->
            <div class="func-option doc-checkups" id="doc-checkups" style="display: none;">
                <div style=" padding-left: 20px; float: left;">
                    <p class="doc-checkups-result">
                    <h6 class="doc-records-item">请假缘由</h6><textarea class="doc-records-input" id="check_des"></textarea>
                    </p>

                    <p class="doc-checkups-type">
                    <h6 class="doc-records-item doc-checkups-item">日期选择</h6>

                    <input type="text" class="form-control" id="dateInput">

                    </p>

                    <div class="doc-records-btngroup" style="margin-top: 100px;"><button class="btn"
                            onclick="submitCheckup()">暂存</button>
                        <button class="btn" style="margin-left: 50px;">打印</button>
                    </div>

                </div>
            </div>
            <!-- End checkups -->
        </div>


    </section>
    <!--/ End portfolio -->


    <!-- jquery Min JS -->
    <script src="js/jquery.min.js"></script>
    <!-- jquery Migrate JS -->
    <script src="js/jquery-migrate-3.0.0.js"></script>
    <!-- jquery Ui JS -->
    <script src="js/jquery-ui.min.js"></script>
    <!-- Easing JS -->
    <script src="js/easing.js"></script>
    <!-- Color JS -->
    <script src="js/colors.js"></script>
    <!-- Popper JS -->
    <script src="js/popper.min.js"></script>
    <!-- Bootstrap Datepicker JS -->
    <script src="js/bootstrap-datepicker.js"></script>
    <script src="locales/bootstrap-datepicker.zh-CN.min.js"></script>
    <!-- Jquery Nav JS -->
    <script src="js/jquery.nav.js"></script>
    <!-- Slicknav JS -->
    <script src="js/slicknav.min.js"></script>
    <!-- ScrollUp JS -->
    <script src="js/jquery.scrollUp.min.js"></script>
    <!-- Niceselect JS -->
    <script src="js/niceselect.js"></script>
    <!-- Tilt Jquery JS -->
    <script src="js/tilt.jquery.min.js"></script>
    <!-- Owl Carousel JS -->
    <script src="js/owl-carousel.js"></script>
    <!-- counterup JS -->
    <script src="js/jquery.counterup.min.js"></script>
    <!-- Steller JS -->
    <script src="js/steller.js"></script>
    <!-- Wow JS -->
    <script src="js/wow.min.js"></script>
    <!-- Magnific Popup JS -->
    <script src="js/jquery.magnific-popup.min.js"></script>
    <!-- Counter Up CDN JS -->
    <script src="js/waypoints.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="js/bootstrap.min.js"></script>
    <!-- Main JS -->
    <script src="js/main.js"></script>

    <style type="text/css">
        /* 定义指针类样式 */
        .pointer {
            cursor: pointer;
            /* 使用 pointer 属性将鼠标指针样式设置为手型，表示可点击 */
        }

        /* 添加CSS样式来美化表格 */
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }



        #meds-drawer {
            margin-top: 10px;
            text-align: right;
            width: 80%;
            /*height: 200px;*/
            padding: 10px 10px;
            border: solid gray 1px;
            border-radius: 10px;
        }

        #searched-meds-name {
            float: left;
        }

        .patient-info {
            height: 20%;
            padding-left: 50px;
        }

        .patient-info-h {
            display: inline-block;
            text-align: center;
            margin-left: 20px;
            margin-right: 50px;
            padding-top: 10px;
        }

        .func-option {
            height: 60%;
        }

        .doc-records-item {
            color: black;
        }

        .doc-checkups-item {
            float: left;
        }

        .doc-records-sympton,
        .doc-records-result,
        .doc-checkups-result,
        .doc-checkups-type {
            padding-left: 30px;
            width: 70%;
            color: black;
            padding-bottom: 30px;
        }

        .doc-records-input {
            margin-left: 30px;
            width: 600px;
            height: 100px;
            resize: none;
        }

        .doc-checkups-input {
            position: absolute;
            margin-left: 95px;
            width: 300px;
            margin-bottom: 30px;
        }

        .doc-records-item {
            float: left;
            padding-top: 10px;
        }

        .doc-records-btngroup {
            margin-left: 100px;
            margin-top: 50px;
        }

        .doc-records-format {
            width: 30%;
            background-color: darkslategrey;
            float: left;
        }

        .doc-history {
            margin-top: 20px;
            margin-left: 20px;
            margin-right: 20px;
        }

        .doc-history-list {
            overflow-y: auto;
            width: 50%;
            float: left;
            height: 550px;
        }

        .doc-history-detail {
            width: 50%;
            overflow-y: scroll;
            border: gray solid 1px;
            float: left;
            display: table;
            height: 500px;
        }

        .history-empty {
            width: 100%;
            height: 100%;
            color: gray;
            text-align: center;
            display: table-cell;
            vertical-align: middle;
        }

        .history-detail-text {
            display: none;
            width: 100%;
            height: 100%;
            resize: none;
            overflow-y: scroll;
        }

        .doc-table {
            color: black;
        }

        .doc-table-input {
            border: solid gainsboro 1px;
            width: 80%;
            margin-right: 10px;
        }


        .doc-table-btn {
            font-size: 10px;
            /* height: 20px; */
            padding: 5px 20px;
        }

        .doc-table-editable {
            background-color: gainsboro;
        }

        .doc-prescriptions-btngroup {
            float: right;
            width: 200px;
            margin-right: 20px;
        }

        .doc-prescriptions-btn {
            width: 180px;
            margin-bottom: 10px;
            margin-top: 10px;
        }
    </style>



    <script>
        // 在页面加载时执行
        window.onload = function () {

            // 找到 ID 为 "doctor-id" 的元素，并将其内容设置为 doctorId
            document.getElementById('doctor-id').innerText = sessionStorage.getItem('doctorId');;
        };

        $(document).ready(function () {
            // 获取医生ID，假设已经存储在sessionStorage中
            const doctorId = sessionStorage.getItem('doctorId');

            // 使用AJAX请求从后端获取数据
            $.ajax({
                url: '/getDoctorAppointments',
                method: 'POST',
                data: { doctorId: doctorId },
                success: function (response) {
                    // 如果成功获取到数据
                    if (response && response.length > 0) {
                        // 创建表格并添加表头
                        let table = '<table><thead><tr>' +
                            '<th data-index="0">预约单号</th>' +
                            '<th data-index="1">预约时间</th>' +
                            '<th data-index="2">患者姓名</th>' +
                            '<th data-index="3">患者性别</th>' +
                            '<th data-index="4">患者电话</th>' +
                            '</tr></thead><tbody>';

                        // 遍历预约数据并添加到表格中
                        response.forEach(ReserveInfoDto => {
                            const genderText = ReserveInfoDto.patientGender === 1 ? '男' : '女';
                            table += `<tr><td>${ReserveInfoDto.reserveId}</td><td>${ReserveInfoDto.reserveTime}</td><td>${ReserveInfoDto.patientName}</td><td>${genderText}</td><td>${ReserveInfoDto.patientTel}</td></tr>`;
                        });

                        table += '</tbody></table>';

                        // 将表格添加到页面中的指定容器中
                        $('#appointmentTableContainer').html(table);

                        // 给表头th绑定点击事件
                        $('th').click(function () {
                            const index = $(this).data('index');
                            sortTable(index);
                        });

                        // 给表头th绑定鼠标悬停事件
                        $('th').hover(function () {
                            $(this).addClass('pointer');
                        }, function () {
                            $(this).removeClass('pointer');
                        });
                    } else {
                        // 如果没有获取到数据，显示相应信息或执行其他操作
                        $('#appointmentTableContainer').html('<p>没有预约数据</p>');
                    }
                },
                error: function (error) {
                    // 如果请求出现错误，显示错误信息或执行其他操作
                    $('#appointmentTableContainer').html('<p>请求数据时出错</p>');
                    console.error('请求预约数据时出错', error);
                }
            });
        });

        let ascendingOrder = true;

        function sortTable(columnIndex) {
            const table = document.querySelector('table');
            const rows = Array.from(table.querySelectorAll('tbody tr'));

            rows.sort((a, b) => {
                let cellA = a.querySelectorAll('td')[columnIndex].textContent.trim();
                let cellB = b.querySelectorAll('td')[columnIndex].textContent.trim();

                // Convert cell content to appropriate types for sorting
                cellA = isNaN(cellA) ? cellA.toUpperCase() : parseFloat(cellA);
                cellB = isNaN(cellB) ? cellB.toUpperCase() : parseFloat(cellB);

                if (cellA < cellB) return ascendingOrder ? -1 : 1;
                if (cellA > cellB) return ascendingOrder ? 1 : -1;
                return 0;
            });

            // Reverse order for next click
            ascendingOrder = !ascendingOrder;

            // Rearrange rows based on sorting
            rows.forEach(row => table.querySelector('tbody').appendChild(row));
        }

    </script>

    <script>
        $('#dateInput').datepicker({
            language: "zh-CN"
        });
    </script>

    <script>
        function showRecords() {
            if ($("records").hasClass('active')) return;

            $("#records").addClass('active')
            if ($("#checkups").hasClass) $("#checkups").removeClass('active')
            if ($("#prescriptions").hasClass) $("#prescriptions").removeClass('active')
            if ($("#history").hasClass) $("#history").removeClass('active')

            $("#doc-records").css('display', 'block')
            $("#doc-checkups").css('display', 'none')
            $("#doc-prescriptions").css('display', 'none')
            $("#doc-history").css('display', 'none')
        }

        function showCheckups() {
            if ($("#checkups").hasClass('active')) return;

            $("#checkups").addClass('active')
            if ($("#records").hasClass('active')) $("#records").removeClass('active')
            if ($("#prescriptions").hasClass('active')) $("#prescriptions").removeClass('active')
            if ($("#history").hasClass('active')) $("#history").removeClass('active')

            $("#doc-records").css('display', 'none')
            $("#doc-checkups").css('display', 'block')
            $("#doc-prescriptions").css('display', 'none')
            $("#doc-history").css('display', 'none')
        }
    </script>

    <script>
        $('.get-quote a').click(function () {
            localStorage.removeItem('doctor_token');
        });


        $(document).ready(function () {
            recordId = $('#patient-infoo').data('id')
            $('#meds-drawer').css('display', 'none')
            $('#searched-meds-name').html('')
            $('#searched-meds-number').html('')

            medsList = []
            registerId = ''
            // 获取这个病人的信息
            $.ajax({
                type: 'get',
                url: '/doctor-main/',
                dataType: 'json',
                cache: false,
                async: false,
                success: function (data) {
                    $('#doctor-id').text(sessionStorage.getItem('doctorId'))
                    registerId = data.register_id
                    var gender = ""
                    if (data.patientGender == 0) {
                        gender = "女"
                    }
                    else gender = "男"
                    $('#patient-name').text("姓名：" + data.patientName)
                    $('#patient-name').data('id', data.patientId)
                    $('#patient-age').text("年龄：" + calAge(data.patientId))
                    $('#patient-gender').text("性别：" + gender)
                    $('#register-number').text("就诊号：" + data.registerNumber)
                },
            })
        })

        function calAge(id) {
            // 默认是中国人
            var dob = id.substring(6, 14)
            var year = dob.substring(0, 4) * 1
            var month = dob.substring(4, 6) * 1
            var day = dob.substring(6) * 1

            var date = new Date()
            var thisYear = date.getFullYear()
            var thisMonth = date.getMonth() + 1
            var thisDay = date.getDate()

            var age = thisYear - year
            if (thisMonth < month) {
                age -= 1
            } else if (thisMonth == month && thisDay < day) {
                age -= 1
            }

            return age;
        }

        function submitRecord() {
            var symptomDescription = '症状描述：' + $('#record-symptom').val() + '\n'
            '诊断结果：' + $('#record-result').val()

            var data_ = {}
            data_['symtomDescription'] = symptomDescription
            data_['patientId'] = $('#patient-name').data('id')

            $.ajax({
                type: 'post',
                dataType: 'json',
                // contentType: 'application/json',
                url: '/doctor-main/record',
                data: data_,
                success: function (data) {
                    if (data.recordStatus == 'ok') {
                        alert('暂存成功！')
                        recordId = data.recordId
                        $('#patient-infoo').data('id', recordId)
                    } else {
                        alert('暂存失败！')
                    }
                },

            })

        }

        function submitCheckup() {
            var checkDescription = $('#checkup-item').val()
            // console.log(checkDescription)
            var data_ = {}
            data_['checkDescription'] = checkDescription
            data_['patientId'] = $('#patient-name').data('id')
            data_['recordId'] = recordId
            $.ajax({
                type: 'post',
                dataType: 'json',
                // contentType: 'application/json',
                data: data_,
                url: '/doctor-main/check',
                success: function (data) {
                    console.log(data)
                    alert('暂存成功！')
                }
            });

        }

        function searchMed() {
            var medName = $('#meds-name').val()
            $.ajax({
                type: 'get',
                url: '/doctor-main/medicineSearch?medicineName=' + medName,
                dataType: 'json',
                async: true,
                success: function (data) {
                    console.log(data)
                    if (data.status == 'ok') {
                        $('#meds-drawer').css('display', 'block')
                        $('#meds-drawer').data('id', data.medicineId)
                        $('#searched-meds-name').text(data.medicineName)
                        $('#searched-meds-number').text(data.medicineNumber)
                    } else {
                        alert(data.msg)
                    }
                }
            })
        }

        $('#meds-drawer').click(function () {
            var medId = $(this).data('id')
            console.log(medId)
            var medName = $('#searched-meds-name').text()
            addMed(medId, medName)
            $(this).css('display', 'none')
            $('#meds-name').val('')
        })

        function addMed(medicineId, medicineName) {
            $('#meds-list').append(
                '<tr>' +
                '<td>' + medicineId + '</td>' +
                '<td>' + medicineName + '</td>' +
                '<td class="doc-table-editable" contenteditable="">1</td>' +
                '<td><button class="btn doc-table-btn" onclick="deleteMed(this)">删除</button></td>' +
                '</tr>'
            )
            medsList.push(medicineId)
        }

        function deleteMed(e) {
            var medId = $(e).parent().parent().children()[0]
            var i = medsList.indexOf(medId)
            medsList.splice(i, 1)
            $(e).parent().parent().remove()
        }

        function submitPrescription() {
            var data_ = {}
            data_['recordId'] = recordId
            data_['patientId'] = $('#patient-name').data('id')
            data_['medicineId'] = ''
            data_['medicineNumber'] = ''

            var tds = $('#meds-list').children().children()
            console.log(tds)
            for (let i = 0; i < tds.length; i += 4) {
                data_['medicineId'] += ',' + tds[i].innerHTML
                data_['medicineNumber'] += ',' + tds[i + 2].innerHTML

                // console.log(data_['medicineId'])
                // console.log(data_['medicineNumber'])
            }
            // console.log(data_)
            data_['medicineId'] = data_['medicineId'].substring(1)
            data_['medicineNumber'] = data_['medicineNumber'].substring(1)

            $.ajax({
                type: 'post',
                dataType: 'json',
                // contentType: 'application/json',
                url: '/doctor-main/prescriptionCreate',
                data: data_,
                success: function (data) {
                    //
                    alert('暂存成功！')
                }
            })

        }

        function getHistory() {
            departmentId2Name = {
                'DE000001': '内科',
                'DE000002': '外科',
                'DE000003': '儿科',
                'DE000004': '五官科',
                'DE000005': '皮肤科',
                'DE000006': '康复科',
            }
            $('#history-list').html('')
            var patientId = $('#patient-name').data('id')
            // console.log(patientId)
            $.ajax({
                type: 'get',
                cache: 'false',
                url: '/doctor-main/historyRecord?patientId=' + patientId,
                async: 'false',
                dataType: 'json',
                success: function (data) {
                    for (let i = 0; i < data.length; i++) {
                        var d = new Date(data[i].billTime);
                        var year = d.getFullYear()
                        var month = d.getMonth() + 1
                        var day = d.getDate()
                        var date = year + '-' + month + '-' + day
                        var time = d.getHours()
                        if (time < 10) {
                            time = '0' + time
                        }
                        time = date + ' ' + time + ":" + d.getMinutes() + ":" + d.getSeconds()
                        $('#history-list').append(
                            '<tr>' +
                            '<td>' + data[i].recordId + '</td>' +
                            '<td>' + time + '</td>' +
                            '<td>' + departmentId2Name[data[i].departmentId] + '-' + data[i].doctorName + '</td>' +
                            '<td><button class="btn doc-table-btn" onclick="getDetail(this)">查看</button></td>' +
                            '</tr>'
                        )
                    }
                }
            })
        }

        function getDetail(e) {
            console.log('????')
            $('.history-empty').css('display', 'none')
            $('.history-detail-text').css('display', 'block')
            // $('.history-detail-text').val('test')

            var recordId = $(e).parent().parent().children()[0].innerText
            $.ajax({
                type: 'get',
                cache: 'false',
                url: '/doctor-main/detailedRecord?recordId=' + recordId,
                dataType: 'json',
                async: 'false',
                success: function (data) {
                    var symptonDescription = data.symptomDescription
                    var medicineName = data.medicineNames
                    var medicineNumber = data.medicineNumbers
                    var checkDescription = data.checkDescriptions

                    var medHistory = '\n给药：\n'
                    if (medicineName != '') {
                        medicineName = medicineName.split(',')
                        medicineNumber = medicineNumber.split(',')
                        for (let i = 0; i < medicineName.length - 1; i++) {
                            var tmp = medicineName[i] + '       用量：' + medicineNumber[i] + '\n'
                            medHistory += tmp
                        }
                    } else {
                        medHistory += '无给药信息' + '\n'
                    }
                    var checkupHistory = '\n检查检验：\n'
                    if (checkDescription != '') {
                        checkDescription = checkDescription.split(',')
                        for (let i = 0; i < checkDescription.length - 1; i++) {
                            checkupHistory += checkDescription + '结果：无明显异常\n'
                        }
                    } else {
                        checkupHistory += '无检查检验信息' + '\n'
                    }

                    var history = symptonDescription + medHistory + checkupHistory
                    console.log(history)
                    $('.history-detail-text').val(history)
                }
            })
        }

        function nextPatient() {

            $.ajax({
                type: 'get',
                url: '/doctor-main/next',
                data: { "registerId": registerId },
                dataType: 'json',
                success: function (data) {
                    alert('诊毕！')

                    registerId = data.register_id
                    var gender = ""
                    if (data.patientGender == 0) {
                        gender = "女"
                    }
                    else gender = "男"
                    $('#patient-name').text("姓名：" + data.patientName)
                    $('#patient-name').data('id', data.patientId)
                    $('#patient-age').text("年龄：" + calAge(data.patientId))
                    $('#patient-gender').text("性别：" + gender)
                    $('#register-number').text("就诊号：" + data.registerNumber)

                    // $('#patient-name').text(data.patientName)
                    // $('#patient-name').data('id', data.patientId)
                    // $('#patient-age').text(calAge(data.patientId))
                    // $('#patient-gender').text(data.patientGender)
                    // $('#register-number').text(data.registerNumber)
                    location.reload()
                },
            })
        }
    </script>

</body>


</html>